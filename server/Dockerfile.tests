# --- Stage 1: Build ---
FROM ubuntu:22.04 AS build

# Build-Tools
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    git \
    libpqxx-dev \
    libpq5 \
    libstdc++6 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Project files kopieren
COPY CMakeLists.txt . 
COPY src/ ./src/
COPY tests/ ./tests/
COPY lib/ ./lib/

# Build-Ordner
RUN mkdir build
WORKDIR /app/build

# CMake & Build
RUN cmake .. -DCMAKE_BUILD_TYPE=Debug
RUN cmake --build . --target unit_tests

# --- Stage 2: Runtime for Tests ---
FROM ubuntu:22.04
WORKDIR /app

# Nur das Test-Executable kopieren
COPY --from=build /app/build/bin/unit_tests .

# Runtime libs
RUN apt-get update && apt-get install -y \
    libpq5 \
    libstdc++6 \
    && rm -rf /var/lib/apt/lists/*

# Tests automatisch ausf√ºhren
CMD ["./unit_tests"]

